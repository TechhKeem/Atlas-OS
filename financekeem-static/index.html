<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FinanceKeem - Protection Planning</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            charcoal: '#20242D',
            sage: '#5CA581',
            platinum: '#C1C4C8',
            softwhite: '#F6F7F9',
          }
        }
      }
    }
  </script>
  <style>
    [x-cloak] { display: none !important; }
  </style>
</head>
<body class="bg-softwhite min-h-screen">
  <div id="app"></div>

  <script type="module">
    // ============== DATABASE ==============
    const STORAGE_KEY = 'financekeem_data';
    
    function getData() {
      const data = localStorage.getItem(STORAGE_KEY);
      return data ? JSON.parse(data) : { leads: [], forms: [], quizzes: [], bookingPages: [], bookings: [] };
    }
    
    function saveData(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }
    
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
    }
    
    function generateSlug(name) {
      return name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') + '-' + Math.random().toString(36).substr(2, 6);
    }

    // Format phone
    function formatPhone(value) {
      const numbers = value.replace(/\D/g, '');
      if (numbers.length <= 3) return numbers;
      if (numbers.length <= 6) return `(${numbers.slice(0, 3)}) ${numbers.slice(3)}`;
      return `(${numbers.slice(0, 3)}) ${numbers.slice(3, 6)}-${numbers.slice(6, 10)}`;
    }

    const db = {
      getLeads: () => getData().leads,
      
      upsertLead(lead) {
        const data = getData();
        const email = lead.email?.toLowerCase().trim();
        
        if (email) {
          const idx = data.leads.findIndex(l => l.email?.toLowerCase().trim() === email);
          if (idx !== -1) {
            data.leads[idx] = { ...data.leads[idx], ...lead, updated_at: new Date().toISOString() };
            saveData(data);
            return data.leads[idx];
          }
        }
        
        const newLead = { id: generateId(), ...lead, status: 'new', created_at: new Date().toISOString() };
        data.leads.unshift(newLead);
        saveData(data);
        return newLead;
      },
      
      updateLead(id, updates) {
        const data = getData();
        const idx = data.leads.findIndex(l => l.id === id);
        if (idx !== -1) {
          data.leads[idx] = { ...data.leads[idx], ...updates };
          saveData(data);
        }
      },
      
      deleteLead(id) {
        const data = getData();
        data.leads = data.leads.filter(l => l.id !== id);
        saveData(data);
      },

      getForms: () => getData().forms,
      createForm(form) {
        const data = getData();
        const newForm = {
          id: generateId(),
          name: form.name || 'New Form',
          slug: generateSlug(form.name || 'form'),
          description: form.description || '',
          fields: [
            { id: 'name', type: 'text', label: 'Full Name', required: true },
            { id: 'email', type: 'email', label: 'Email', required: true },
            { id: 'phone', type: 'tel', label: 'Phone', required: false }
          ],
          status: 'active',
          created_at: new Date().toISOString()
        };
        data.forms.unshift(newForm);
        saveData(data);
        return newForm;
      },
      deleteForm(id) {
        const data = getData();
        data.forms = data.forms.filter(f => f.id !== id);
        saveData(data);
      },
      getFormBySlug(slug) {
        return getData().forms.find(f => f.slug === slug);
      },

      getQuizzes: () => getData().quizzes,
      createQuiz(quiz) {
        const data = getData();
        const newQuiz = {
          id: generateId(),
          name: quiz.name || 'New Quiz',
          slug: generateSlug(quiz.name || 'quiz'),
          description: quiz.description || '',
          status: 'active',
          created_at: new Date().toISOString()
        };
        data.quizzes.unshift(newQuiz);
        saveData(data);
        return newQuiz;
      },
      deleteQuiz(id) {
        const data = getData();
        data.quizzes = data.quizzes.filter(q => q.id !== id);
        saveData(data);
      },

      getBookingPages: () => getData().bookingPages,
      createBookingPage(page) {
        const data = getData();
        const newPage = {
          id: generateId(),
          name: page.name || 'New Booking Page',
          slug: generateSlug(page.name || 'booking'),
          description: page.description || '',
          duration: 30,
          availability: { days: ['monday','tuesday','wednesday','thursday','friday'], startTime: '09:00', endTime: '17:00' },
          status: 'active',
          created_at: new Date().toISOString()
        };
        data.bookingPages.unshift(newPage);
        saveData(data);
        return newPage;
      },
      deleteBookingPage(id) {
        const data = getData();
        data.bookingPages = data.bookingPages.filter(b => b.id !== id);
        saveData(data);
      },
      getBookingPageBySlug(slug) {
        return getData().bookingPages.find(b => b.slug === slug);
      },

      getBookings: () => getData().bookings,
      createBooking(booking) {
        const data = getData();
        const newBooking = { id: generateId(), ...booking, status: 'scheduled', created_at: new Date().toISOString() };
        data.bookings.push(newBooking);
        saveData(data);
        db.upsertLead({ name: booking.name, email: booking.email, phone: booking.phone, status: 'scheduled', source: 'booking' });
        return newBooking;
      }
    };

    // ============== ICONS ==============
    const icons = {
      database: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/><path d="M3 12c0 1.66 4 3 9 3s9-1.34 9-3"/></svg>`,
      calendar: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="4" rx="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>`,
      file: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg>`,
      link: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>`,
      settings: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m-9-9h6m6 0h6"/></svg>`,
      plus: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>`,
      trash: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>`,
      copy: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="14" height="14" x="8" y="8" rx="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`,
      check: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6 9 17l-5-5"/></svg>`,
      external: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M10 14 21 3M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg>`,
      menu: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>`,
      x: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>`,
      chevronLeft: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>`,
      chevronRight: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>`,
    };

    // ============== APP STATE ==============
    let currentPage = 'database';
    let sidebarCollapsed = false;
    let mobileMenuOpen = false;

    // ============== ROUTER ==============
    function getRoute() {
      const hash = window.location.hash.slice(1) || '/';
      return hash;
    }

    function navigate(path) {
      window.location.hash = path;
    }

    // ============== RENDER FUNCTIONS ==============
    function render() {
      const route = getRoute();
      const app = document.getElementById('app');
      
      // Public routes (no sidebar)
      if (route.startsWith('/quiz/')) {
        app.innerHTML = renderQuizPage(route.split('/quiz/')[1]);
        return;
      }
      if (route.startsWith('/form/')) {
        app.innerHTML = renderFormPage(route.split('/form/')[1]);
        return;
      }
      if (route.startsWith('/book/')) {
        app.innerHTML = renderBookingPage(route.split('/book/')[1]);
        return;
      }

      // Admin routes (with sidebar)
      let pageContent = '';
      if (route === '/' || route === '/database') {
        currentPage = 'database';
        pageContent = renderDatabasePage();
      } else if (route === '/calendar') {
        currentPage = 'calendar';
        pageContent = renderCalendarPage();
      } else if (route === '/lead-capture') {
        currentPage = 'lead-capture';
        pageContent = renderLeadCapturePage();
      } else if (route === '/booking-pages') {
        currentPage = 'booking-pages';
        pageContent = renderBookingPagesAdmin();
      } else if (route === '/settings') {
        currentPage = 'settings';
        pageContent = renderSettingsPage();
      } else {
        currentPage = 'database';
        pageContent = renderDatabasePage();
      }

      app.innerHTML = renderLayout(pageContent);
      attachEventListeners();
    }

    function renderLayout(content) {
      const navItems = [
        { id: 'database', name: 'Database', path: '/', icon: icons.database },
        { id: 'calendar', name: 'Calendar', path: '/calendar', icon: icons.calendar },
        { id: 'lead-capture', name: 'Lead Capture', path: '/lead-capture', icon: icons.file },
        { id: 'booking-pages', name: 'Booking Pages', path: '/booking-pages', icon: icons.link },
        { id: 'settings', name: 'Settings', path: '/settings', icon: icons.settings },
      ];

      return `
        <div class="min-h-screen bg-softwhite">
          <!-- Mobile header -->
          <div class="lg:hidden fixed top-0 left-0 right-0 h-14 bg-white border-b border-platinum z-50 flex items-center justify-between px-4">
            <span class="text-base font-semibold text-charcoal">FinanceKeem</span>
            <button onclick="toggleMobileMenu()" class="p-2 text-charcoal">${mobileMenuOpen ? icons.x : icons.menu}</button>
          </div>

          <!-- Mobile overlay -->
          ${mobileMenuOpen ? `<div class="lg:hidden fixed inset-0 bg-black/20 z-40" onclick="toggleMobileMenu()"></div>` : ''}

          <!-- Sidebar -->
          <aside class="fixed left-0 top-0 h-full bg-white border-r border-platinum z-40 transition-all duration-300 flex flex-col ${sidebarCollapsed ? 'lg:w-16' : 'lg:w-56'} w-56 ${mobileMenuOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}">
            <div class="h-14 flex items-center justify-between border-b border-platinum px-4">
              ${!sidebarCollapsed ? '<span class="text-base font-semibold text-charcoal">Schedule</span>' : ''}
              <button onclick="toggleSidebar()" class="p-1.5 text-charcoal hover:bg-softwhite rounded hidden lg:flex ${sidebarCollapsed ? 'mx-auto' : ''}">
                ${sidebarCollapsed ? icons.chevronRight : icons.chevronLeft}
              </button>
              <button onclick="toggleMobileMenu()" class="lg:hidden p-1.5 text-charcoal">${icons.x}</button>
            </div>

            <nav class="flex-1 py-4 px-2">
              <ul class="space-y-1">
                ${navItems.map(item => `
                  <li>
                    <a href="#${item.path}" onclick="closeMobileMenu()" class="flex items-center gap-3 px-3 py-2.5 rounded-md transition-colors ${currentPage === item.id ? 'bg-charcoal text-white' : 'text-charcoal hover:bg-softwhite'} ${sidebarCollapsed ? 'lg:justify-center lg:px-2' : ''}">
                      ${item.icon}
                      ${!sidebarCollapsed ? `<span class="text-sm font-medium">${item.name}</span>` : ''}
                    </a>
                  </li>
                `).join('')}
              </ul>
            </nav>

            <div class="border-t border-platinum p-3">
              <div class="flex items-center gap-3 ${sidebarCollapsed ? 'lg:justify-center' : ''}">
                <div class="w-8 h-8 bg-charcoal text-white rounded flex items-center justify-center text-sm font-semibold">F</div>
                ${!sidebarCollapsed ? '<span class="text-sm font-medium text-charcoal">Finance Keem</span>' : ''}
              </div>
            </div>
          </aside>

          <!-- Main content -->
          <main class="min-h-screen pt-14 lg:pt-0 transition-all duration-300 ${sidebarCollapsed ? 'lg:ml-16' : 'lg:ml-56'}">
            ${content}
          </main>
        </div>
      `;
    }

    // ============== DATABASE PAGE ==============
    function renderDatabasePage() {
      const leads = db.getLeads();
      
      const statusColors = {
        new: 'bg-blue-100 text-blue-800',
        contacted: 'bg-purple-100 text-purple-800',
        scheduled: 'bg-green-100 text-green-800',
        completed: 'bg-gray-100 text-gray-800'
      };

      return `
        <div class="h-full flex flex-col">
          <div class="bg-white border-b border-platinum px-6 py-4">
            <h1 class="text-lg font-semibold text-charcoal">Database</h1>
            <p class="text-sm text-platinum">${leads.length} total leads</p>
          </div>

          <div class="flex-1 overflow-auto">
            ${leads.length === 0 ? `
              <div class="flex flex-col items-center justify-center h-64 text-center p-6">
                <p class="text-charcoal font-medium mb-2">No leads yet</p>
                <p class="text-sm text-platinum">Leads will appear here when people fill out your forms, quizzes, or book appointments.</p>
              </div>
            ` : `
              <table class="w-full">
                <thead class="bg-softwhite border-b border-platinum sticky top-0">
                  <tr>
                    <th class="text-left px-4 py-3 text-xs font-medium text-charcoal uppercase">Name</th>
                    <th class="text-left px-4 py-3 text-xs font-medium text-charcoal uppercase">Email</th>
                    <th class="text-left px-4 py-3 text-xs font-medium text-charcoal uppercase">Phone</th>
                    <th class="text-left px-4 py-3 text-xs font-medium text-charcoal uppercase">Status</th>
                    <th class="text-left px-4 py-3 text-xs font-medium text-charcoal uppercase">Source</th>
                    <th class="px-4 py-3"></th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-platinum/50">
                  ${leads.map(lead => `
                    <tr class="hover:bg-softwhite">
                      <td class="px-4 py-3 text-sm font-medium text-charcoal">${lead.name || '—'}</td>
                      <td class="px-4 py-3 text-sm text-charcoal">${lead.email || '—'}</td>
                      <td class="px-4 py-3 text-sm text-charcoal">${lead.phone || '—'}</td>
                      <td class="px-4 py-3">
                        <span class="text-xs px-2 py-1 rounded ${statusColors[lead.status] || 'bg-gray-100'}">${lead.status || 'new'}</span>
                      </td>
                      <td class="px-4 py-3 text-sm text-platinum">${lead.source || '—'}</td>
                      <td class="px-4 py-3">
                        <button onclick="deleteLead('${lead.id}')" class="p-1 text-platinum hover:text-red-500">${icons.trash}</button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `}
          </div>
        </div>
      `;
    }

    // ============== CALENDAR PAGE ==============
    function renderCalendarPage() {
      const bookings = db.getBookings();
      return `
        <div class="p-6">
          <h1 class="text-2xl font-semibold text-charcoal mb-2">Calendar</h1>
          <p class="text-sm text-platinum mb-6">View scheduled appointments</p>
          
          <div class="bg-white border border-platinum rounded-lg p-6">
            ${bookings.length === 0 ? `
              <p class="text-platinum text-center py-8">No appointments scheduled yet.</p>
            ` : `
              <div class="space-y-3">
                ${bookings.map(b => `
                  <div class="flex items-center justify-between p-3 bg-softwhite rounded">
                    <div>
                      <p class="font-medium text-charcoal">${b.name}</p>
                      <p class="text-sm text-platinum">${b.email}</p>
                    </div>
                    <div class="text-right">
                      <p class="text-sm text-charcoal">${b.date}</p>
                      <p class="text-xs text-platinum">${b.time}</p>
                    </div>
                  </div>
                `).join('')}
              </div>
            `}
          </div>
        </div>
      `;
    }

    // ============== LEAD CAPTURE PAGE ==============
    function renderLeadCapturePage() {
      const forms = db.getForms();
      const quizzes = db.getQuizzes();
      
      return `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-2xl font-semibold text-charcoal">Lead Capture</h1>
              <p class="text-sm text-platinum mt-1">Create forms and quizzes to capture leads</p>
            </div>
          </div>

          <!-- Forms Section -->
          <div class="mb-8">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-base font-semibold text-charcoal">Forms (${forms.length})</h2>
              <button onclick="createForm()" class="flex items-center gap-2 px-3 py-1.5 bg-charcoal text-white text-sm rounded hover:bg-charcoal/90">
                ${icons.plus} Create Form
              </button>
            </div>
            ${forms.length === 0 ? `
              <div class="bg-white border border-platinum rounded p-8 text-center">
                <p class="text-platinum">No forms yet. Create your first form to capture leads.</p>
              </div>
            ` : `
              <div class="space-y-3">
                ${forms.map(form => `
                  <div class="bg-white border border-platinum rounded p-4 flex items-center justify-between">
                    <div>
                      <h3 class="font-medium text-charcoal">${form.name}</h3>
                      <p class="text-sm text-platinum">${window.location.origin}/#/form/${form.slug}</p>
                    </div>
                    <div class="flex items-center gap-2">
                      <button onclick="copyLink('form', '${form.slug}')" class="p-2 text-platinum hover:text-charcoal">${icons.copy}</button>
                      <a href="#/form/${form.slug}" target="_blank" class="p-2 text-platinum hover:text-charcoal">${icons.external}</a>
                      <button onclick="deleteForm('${form.id}')" class="p-2 text-platinum hover:text-red-500">${icons.trash}</button>
                    </div>
                  </div>
                `).join('')}
              </div>
            `}
          </div>

          <!-- Quizzes Section -->
          <div>
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-base font-semibold text-charcoal">Quizzes (${quizzes.length + 1})</h2>
              <button onclick="createQuiz()" class="flex items-center gap-2 px-3 py-1.5 bg-charcoal text-white text-sm rounded hover:bg-charcoal/90">
                ${icons.plus} Create Quiz
              </button>
            </div>
            <div class="space-y-3">
              <!-- Built-in Protection Assessment -->
              <div class="bg-white border border-platinum rounded p-4 flex items-center justify-between">
                <div>
                  <h3 class="font-medium text-charcoal">Protection & Alignment Assessment</h3>
                  <p class="text-sm text-platinum">${window.location.origin}/#/quiz/protection-assessment</p>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-xs bg-sage/20 text-sage px-2 py-1 rounded">Built-in</span>
                  <button onclick="copyLink('quiz', 'protection-assessment')" class="p-2 text-platinum hover:text-charcoal">${icons.copy}</button>
                  <a href="#/quiz/protection-assessment" target="_blank" class="p-2 text-platinum hover:text-charcoal">${icons.external}</a>
                </div>
              </div>
              ${quizzes.map(quiz => `
                <div class="bg-white border border-platinum rounded p-4 flex items-center justify-between">
                  <div>
                    <h3 class="font-medium text-charcoal">${quiz.name}</h3>
                    <p class="text-sm text-platinum">${window.location.origin}/#/quiz/${quiz.slug}</p>
                  </div>
                  <div class="flex items-center gap-2">
                    <button onclick="copyLink('quiz', '${quiz.slug}')" class="p-2 text-platinum hover:text-charcoal">${icons.copy}</button>
                    <button onclick="deleteQuiz('${quiz.id}')" class="p-2 text-platinum hover:text-red-500">${icons.trash}</button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    // ============== BOOKING PAGES ADMIN ==============
    function renderBookingPagesAdmin() {
      const pages = db.getBookingPages();
      
      return `
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-2xl font-semibold text-charcoal">Booking Pages</h1>
              <p class="text-sm text-platinum mt-1">Create booking pages for scheduling</p>
            </div>
            <button onclick="createBookingPage()" class="flex items-center gap-2 px-4 py-2 bg-charcoal text-white text-sm rounded hover:bg-charcoal/90">
              ${icons.plus} Create Booking Page
            </button>
          </div>

          ${pages.length === 0 ? `
            <div class="bg-white border border-platinum rounded p-12 text-center">
              <p class="text-platinum mb-4">No booking pages yet.</p>
              <button onclick="createBookingPage()" class="px-4 py-2 bg-charcoal text-white text-sm rounded">Create Booking Page</button>
            </div>
          ` : `
            <div class="space-y-4">
              ${pages.map(page => `
                <div class="bg-white border border-platinum rounded overflow-hidden">
                  <div class="p-4 flex items-center justify-between">
                    <div>
                      <h3 class="font-medium text-charcoal">${page.name}</h3>
                      <p class="text-sm text-platinum mt-1">${page.duration} minutes</p>
                    </div>
                    <div class="flex items-center gap-2">
                      <button onclick="copyLink('book', '${page.slug}')" class="p-2 text-platinum hover:text-charcoal">${icons.copy}</button>
                      <a href="#/book/${page.slug}" target="_blank" class="p-2 text-platinum hover:text-charcoal">${icons.external}</a>
                      <button onclick="deleteBookingPage('${page.id}')" class="p-2 text-platinum hover:text-red-500">${icons.trash}</button>
                    </div>
                  </div>
                  <div class="px-4 py-3 bg-softwhite border-t border-platinum">
                    <code class="text-xs text-charcoal">${window.location.origin}/#/book/${page.slug}</code>
                  </div>
                </div>
              `).join('')}
            </div>
          `}
        </div>
      `;
    }

    // ============== SETTINGS PAGE ==============
    function renderSettingsPage() {
      return `
        <div class="p-6">
          <h1 class="text-2xl font-semibold text-charcoal mb-2">Settings</h1>
          <p class="text-sm text-platinum mb-6">Configure your application</p>

          <div class="max-w-xl space-y-6">
            <div class="bg-white border border-platinum rounded-lg p-6">
              <h2 class="font-semibold text-charcoal mb-4">Public Links</h2>
              <div class="space-y-3">
                <div>
                  <label class="text-xs text-platinum uppercase">Protection Assessment</label>
                  <div class="flex gap-2 mt-1">
                    <input type="text" value="${window.location.origin}/#/quiz/protection-assessment" readonly class="flex-1 px-3 py-2 bg-softwhite border border-platinum rounded text-sm">
                    <button onclick="copyLink('quiz', 'protection-assessment')" class="px-4 py-2 bg-charcoal text-white rounded text-sm">${icons.copy}</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="bg-white border border-platinum rounded-lg p-6">
              <h2 class="font-semibold text-charcoal mb-4">Data Management</h2>
              <p class="text-sm text-platinum mb-4">Your data is stored in your browser's local storage.</p>
              <button onclick="clearAllData()" class="px-4 py-2 text-red-600 border border-red-200 rounded text-sm hover:bg-red-50">
                Clear All Data
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // ============== PUBLIC QUIZ PAGE ==============
    function renderQuizPage(slug) {
      if (slug !== 'protection-assessment') {
        return `<div class="min-h-screen bg-softwhite flex items-center justify-center"><p class="text-charcoal">Quiz not found</p></div>`;
      }
      
      return `
        <div class="min-h-screen bg-softwhite py-12 px-6" id="quiz-container">
          <div class="max-w-xl mx-auto">
            <div class="bg-white border border-platinum rounded-lg overflow-hidden">
              <div class="p-8 text-center">
                <h1 class="text-2xl font-semibold text-charcoal mb-4">Protection & Alignment Assessment</h1>
                <p class="text-platinum mb-6">This 12-question assessment will help you understand whether your financial protection is coordinated and being maintained.</p>
                <p class="text-sm text-platinum mb-8">Takes about 3-5 minutes.</p>
                <button onclick="startQuiz()" class="px-8 py-3 bg-charcoal text-white font-medium rounded hover:bg-charcoal/90">Start Assessment</button>
              </div>
            </div>
            <p class="text-xs text-platinum text-center mt-4">Powered by FinanceKeem</p>
          </div>
        </div>
      `;
    }

    // ============== PUBLIC FORM PAGE ==============
    function renderFormPage(slug) {
      const form = db.getFormBySlug(slug);
      if (!form) {
        return `<div class="min-h-screen bg-softwhite flex items-center justify-center"><p class="text-charcoal">Form not found</p></div>`;
      }

      return `
        <div class="min-h-screen bg-softwhite py-12 px-6">
          <div class="max-w-lg mx-auto">
            <div class="bg-white border border-platinum rounded-lg overflow-hidden">
              <div class="p-6 border-b border-platinum">
                <h1 class="text-xl font-semibold text-charcoal">${form.name}</h1>
                ${form.description ? `<p class="text-sm text-platinum mt-2">${form.description}</p>` : ''}
              </div>
              <form onsubmit="submitForm(event, '${form.id}')" class="p-6 space-y-4">
                ${form.fields.map(field => `
                  <div>
                    <label class="block text-xs text-platinum uppercase mb-1.5">${field.label}${field.required ? ' *' : ''}</label>
                    <input type="${field.type}" name="${field.id}" ${field.required ? 'required' : ''} class="w-full px-4 py-2.5 border border-platinum rounded text-sm">
                  </div>
                `).join('')}
                <button type="submit" class="w-full py-3 bg-charcoal text-white rounded font-medium hover:bg-charcoal/90 mt-4">Submit</button>
              </form>
            </div>
            <p class="text-xs text-platinum text-center mt-4">Powered by FinanceKeem</p>
          </div>
        </div>
      `;
    }

    // ============== PUBLIC BOOKING PAGE ==============
    function renderBookingPage(slug) {
      let page = db.getBookingPageBySlug(slug);
      if (!page) {
        page = { name: 'Protection Clarity Conversation', description: '30-minute call to review your assessment.', duration: 30 };
      }

      return `
        <div class="min-h-screen bg-softwhite py-12 px-6">
          <div class="max-w-lg mx-auto">
            <div class="bg-white border border-platinum rounded-lg overflow-hidden">
              <div class="p-6 border-b border-platinum">
                <h1 class="text-xl font-semibold text-charcoal">${page.name}</h1>
                <p class="text-sm text-platinum mt-2">${page.description || ''}</p>
                <p class="text-sm text-platinum mt-1">${page.duration} minutes</p>
              </div>
              <form onsubmit="submitBooking(event, '${slug}')" class="p-6 space-y-4">
                <div>
                  <label class="block text-xs text-platinum uppercase mb-1.5">Name *</label>
                  <input type="text" name="name" required class="w-full px-4 py-2.5 border border-platinum rounded text-sm">
                </div>
                <div>
                  <label class="block text-xs text-platinum uppercase mb-1.5">Email *</label>
                  <input type="email" name="email" required class="w-full px-4 py-2.5 border border-platinum rounded text-sm">
                </div>
                <div>
                  <label class="block text-xs text-platinum uppercase mb-1.5">Phone</label>
                  <input type="tel" name="phone" class="w-full px-4 py-2.5 border border-platinum rounded text-sm">
                </div>
                <div>
                  <label class="block text-xs text-platinum uppercase mb-1.5">Preferred Date *</label>
                  <input type="date" name="date" required class="w-full px-4 py-2.5 border border-platinum rounded text-sm">
                </div>
                <div>
                  <label class="block text-xs text-platinum uppercase mb-1.5">Preferred Time *</label>
                  <select name="time" required class="w-full px-4 py-2.5 border border-platinum rounded text-sm">
                    <option value="09:00">9:00 AM</option>
                    <option value="10:00">10:00 AM</option>
                    <option value="11:00">11:00 AM</option>
                    <option value="13:00">1:00 PM</option>
                    <option value="14:00">2:00 PM</option>
                    <option value="15:00">3:00 PM</option>
                    <option value="16:00">4:00 PM</option>
                  </select>
                </div>
                <button type="submit" class="w-full py-3 bg-charcoal text-white rounded font-medium hover:bg-charcoal/90 mt-4">Book Appointment</button>
              </form>
            </div>
            <p class="text-xs text-platinum text-center mt-4">Powered by FinanceKeem</p>
          </div>
        </div>
      `;
    }

    // ============== GLOBAL FUNCTIONS ==============
    window.toggleSidebar = () => { sidebarCollapsed = !sidebarCollapsed; render(); };
    window.toggleMobileMenu = () => { mobileMenuOpen = !mobileMenuOpen; render(); };
    window.closeMobileMenu = () => { mobileMenuOpen = false; };

    window.deleteLead = (id) => { if(confirm('Delete this lead?')) { db.deleteLead(id); render(); } };
    window.createForm = () => { db.createForm({ name: 'New Lead Form' }); render(); };
    window.deleteForm = (id) => { if(confirm('Delete this form?')) { db.deleteForm(id); render(); } };
    window.createQuiz = () => { db.createQuiz({ name: 'New Quiz' }); render(); };
    window.deleteQuiz = (id) => { if(confirm('Delete this quiz?')) { db.deleteQuiz(id); render(); } };
    window.createBookingPage = () => { db.createBookingPage({ name: 'New Booking Page' }); render(); };
    window.deleteBookingPage = (id) => { if(confirm('Delete this booking page?')) { db.deleteBookingPage(id); render(); } };
    
    window.copyLink = (type, slug) => {
      navigator.clipboard.writeText(`${window.location.origin}/#/${type}/${slug}`);
      alert('Link copied!');
    };

    window.clearAllData = () => {
      if(confirm('This will delete ALL your data. Are you sure?')) {
        localStorage.removeItem(STORAGE_KEY);
        render();
      }
    };

    window.submitForm = (e, formId) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      db.upsertLead({
        name: formData.get('name'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        source: 'form'
      });
      e.target.innerHTML = '<div class="p-8 text-center"><p class="text-sage text-xl mb-2">✓</p><p class="font-semibold text-charcoal">Thank you!</p><p class="text-platinum">Your submission has been received.</p></div>';
    };

    window.submitBooking = (e, slug) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      db.createBooking({
        name: formData.get('name'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        date: formData.get('date'),
        time: formData.get('time'),
        bookingPageSlug: slug
      });
      e.target.innerHTML = '<div class="p-8 text-center"><p class="text-sage text-xl mb-2">✓</p><p class="font-semibold text-charcoal">Booking Confirmed!</p><p class="text-platinum">We will see you soon.</p></div>';
    };

    window.startQuiz = () => {
      window.quizStep = 0;
      window.quizAnswers = {};
      renderQuizStep();
    };

    // Quiz questions
    const quizQuestions = [
      { id: 'p1', q: 'Which best describes your current life insurance coverage?', opts: ['Intentionally designed around my responsibilities', 'Set up a while ago or rough estimate', 'Some coverage through work', 'No life insurance'] },
      { id: 'p2', q: 'How confident are you that your coverage would support your dependents?', opts: ['Very confident', 'Somewhat confident', 'Not very confident', 'Unsure'] },
      { id: 'p3', q: 'How were your responsibilities considered when coverage was set up?', opts: ['All accounted for', 'Some considered', 'Minimal consideration', 'Not factored in'] },
      { id: 'p4', q: 'How intentional are your beneficiary designations?', opts: ['Fully intentional and reviewed', 'Intentional but not reviewed', 'Unsure if current', 'Not sure who is listed'] },
      { id: 'a1', q: 'Which describes your estate planning documents?', opts: ['Complete and current', 'Have but may be outdated', 'Started but incomplete', 'No documents'] },
      { id: 'a2', q: 'How clear is it who would make decisions on your behalf?', opts: ['Very clear and documented', 'Somewhat clear', 'Informally discussed', 'Not clear'] },
      { id: 'a3', q: 'How confident are you about guardianship decisions?', opts: ['Very confident and documented', 'Somewhat confident', 'Unsure', 'Not considered'] },
      { id: 'a4', q: 'Are your estate documents consistent and aligned?', opts: ['Fully aligned', 'Mostly aligned', 'Likely misaligned', 'Not sure'] },
      { id: 'o1', q: 'When was your protection plan last reviewed?', opts: ['Within last year', 'Within 2-3 years', 'More than 3 years', 'Never fully reviewed'] },
      { id: 'o2', q: 'Have major life changes occurred since your last review?', opts: ['No, changes addressed', 'Yes, updates pending', 'Yes, no updates made', 'Not sure'] },
      { id: 'o3', q: 'Who is responsible for keeping your plan current?', opts: ['Someone helps manage it', 'I try to manage it', 'Update only when major events', 'No one responsible'] },
      { id: 'o4', q: 'How is your plan maintained over time?', opts: ['Regular review process', 'Occasional reviews', 'Reactive reviews', 'No review process'] },
    ];

    window.renderQuizStep = () => {
      const container = document.getElementById('quiz-container') || document.querySelector('main');
      const step = window.quizStep;
      
      if (step < quizQuestions.length) {
        const q = quizQuestions[step];
        container.innerHTML = `
          <div class="min-h-screen bg-softwhite py-12 px-6">
            <div class="max-w-xl mx-auto">
              <div class="bg-white border border-platinum rounded-lg overflow-hidden">
                <div class="h-1 bg-platinum/30"><div class="h-full bg-sage" style="width: ${((step+1)/quizQuestions.length)*100}%"></div></div>
                <div class="p-8">
                  <p class="text-xs text-platinum uppercase mb-4">Question ${step+1} of ${quizQuestions.length}</p>
                  <h2 class="text-lg font-semibold text-charcoal mb-6">${q.q}</h2>
                  <div class="space-y-3">
                    ${q.opts.map((opt, i) => `
                      <button onclick="answerQuiz('${q.id}', ${i})" class="w-full text-left px-4 py-4 border border-platinum rounded hover:border-charcoal transition-colors">
                        <span class="text-sm text-charcoal">${opt}</span>
                      </button>
                    `).join('')}
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (step === quizQuestions.length) {
        // Contact form
        container.innerHTML = `
          <div class="min-h-screen bg-softwhite py-12 px-6">
            <div class="max-w-xl mx-auto">
              <div class="bg-white border border-platinum rounded-lg overflow-hidden">
                <div class="h-1 bg-sage"></div>
                <form onsubmit="submitQuizContact(event)" class="p-8">
                  <h2 class="text-xl font-semibold text-charcoal mb-2">Almost Done!</h2>
                  <p class="text-platinum mb-6">Enter your info to see your results.</p>
                  <div class="space-y-4">
                    <div><label class="block text-xs text-platinum uppercase mb-1.5">Name *</label><input type="text" name="name" required class="w-full px-4 py-3 border border-platinum rounded"></div>
                    <div><label class="block text-xs text-platinum uppercase mb-1.5">Email *</label><input type="email" name="email" required class="w-full px-4 py-3 border border-platinum rounded"></div>
                    <div><label class="block text-xs text-platinum uppercase mb-1.5">Phone</label><input type="tel" name="phone" class="w-full px-4 py-3 border border-platinum rounded"></div>
                  </div>
                  <button type="submit" class="w-full mt-6 py-3 bg-charcoal text-white font-medium rounded hover:bg-charcoal/90">See My Results</button>
                </form>
              </div>
            </div>
          </div>
        `;
      }
    };

    window.answerQuiz = (qId, optIndex) => {
      window.quizAnswers[qId] = optIndex;
      window.quizStep++;
      renderQuizStep();
    };

    window.submitQuizContact = (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const score = Object.values(window.quizAnswers).reduce((sum, v) => sum + (3 - v), 0);
      const maxScore = quizQuestions.length * 3;
      const pct = score / maxScore;
      
      let state = 'Not Yet Protected';
      if (pct >= 0.75) state = 'Well Aligned';
      else if (pct >= 0.5) state = 'In Place, Needs Review';
      else if (pct >= 0.25) state = 'Partially Built';

      db.upsertLead({
        name: formData.get('name'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        source: 'quiz:protection-assessment',
        protection_state: state
      });

      const stateColors = {
        'Well Aligned': 'bg-green-100 text-green-800',
        'In Place, Needs Review': 'bg-yellow-100 text-yellow-800',
        'Partially Built': 'bg-orange-100 text-orange-800',
        'Not Yet Protected': 'bg-red-100 text-red-800'
      };

      document.getElementById('quiz-container').innerHTML = `
        <div class="min-h-screen bg-softwhite py-12 px-6">
          <div class="max-w-xl mx-auto">
            <div class="bg-white border border-platinum rounded-lg p-8 text-center">
              <p class="text-sage text-4xl mb-4">✓</p>
              <h2 class="text-xl font-semibold text-charcoal mb-4">Assessment Complete</h2>
              <div class="inline-block px-6 py-3 rounded-lg ${stateColors[state]} mb-6">
                <p class="text-lg font-semibold">${state}</p>
              </div>
              <p class="text-platinum mb-6">The next step is understanding what should be reviewed, aligned, or put in place.</p>
              <a href="#/book/clarity-call" class="inline-block px-6 py-3 bg-sage text-white font-medium rounded hover:bg-sage/90">Schedule a Clarity Conversation</a>
            </div>
          </div>
        </div>
      `;
    };

    function attachEventListeners() {
      // Phone formatting
      document.querySelectorAll('input[type="tel"]').forEach(input => {
        input.addEventListener('input', (e) => { e.target.value = formatPhone(e.target.value); });
      });
    }

    // ============== INIT ==============
    window.addEventListener('hashchange', render);
    render();
  </script>
</body>
</html>
